<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, shrink-to-fit=no">
    
    <title>사업자등록 상태조회(오픈API 활용, 엑셀용)</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            사업자등록 상태조회<br />(오픈API 활용, 엑셀용)
        </div>
        <div class="main">
            <div class="information">
                Ⅰ. 공공데이터 포털 오픈 API 인증키 &nbsp;&nbsp;
                <input type="text" title="공공데이터포털 오픈API 인증키"  input value="fY3%2FUdws5xC4QrK0%2BIFba4cHZlkAx7K6aZVp%2BgjDy06RdUelobLqZUfug8%2FWbv%2FnZVdeLNTr%2FvB%2Bxkj4SzhzCg%3D%3D" class="form-control" id="openapi_key" name="openapi_key" required />
            </div>
            <div class="sub_information">
                <h6>&nbsp;&nbsp;&nbsp;인증키 발급 및 확인 방법 : </h6>
                <ol>
                    <li><a href="https://www.data.go.kr/" target="_blank">공공데이터포털</a> 회원가입</li>
                    <li><a href="https://www.data.go.kr/" target="_blank">공공데이터포털</a> 로그인</li>
                    <li><a href="https://www.data.go.kr/data/15081808/openapi.do" target="_blank">사업자등록 상태조회 오픈API 서비스</a> 활용신청</li>
                    <li><a href="https://www.data.go.kr/" target="_blank">공공데이터포털</a> > <a href="https://www.data.go.kr/iim/api/selectDevAcountList.do" target="_blank">마이페이지</a> > 오픈API > 
                    <a href="https://www.data.go.kr/iim/api/selectApiKeyList.do" target="_blank">인증키 발급현황</a> > 인증키 > 복사 & 붙여넣기</li>
                </ol>
            </div>
        </div>
        <div class="main">
            <div class="information">
                Ⅱ.&nbsp;&nbsp;상태조회 엑셀 서식 <a href="https://www.data.go.kr/cmm/cmm/fileDownload.do?atchFileId=FILE_000000002402264&fileDetailSn=1" target="_blank">내려받기</a><br />
            </div>
        </div>
        <!--
        <div class="main">
            <div class="information">
                Ⅲ.&nbsp;&nbsp;진위확인 엑셀 업로드&nbsp;&nbsp;
                <input type="file" id="check_infor_file" onchange="check(event, openapi_key, 1)" />
            </div>
            <div class="sub_information">
                <ol>
                    <li><a href="진위확인(서식).xlsx" target="_blank">진위확인 엑셀 서식 다운로드</a></li>
                    <li>엑셀 서식(변경 금지)에 맞춰 확인할 정보 입력(<a href="https://www.data.go.kr/data/15081808/openapi.do" target="_blank">입력 정보 세부내용 확인</a>)</li>
                    <li>파일 선택 버튼 클릭 > 작성한 엑셀 파일 클릭 > 열기 버튼 클릭</li>
                    <li>다운로드된 엑셀 파일 내용 확인(오류 발생 시, 작성한 오류 수정 후 재시도)</li>
                </ol>
            </div>
        </div>
        -->
        <div class="main">
            <div class="information">
                Ⅲ.&nbsp;&nbsp;상태조회 엑셀 업로드&nbsp;&nbsp;
                <!-- <button onclick="check_num(openapi_key)">클릭</button> -->
                <input type="file" id="check_num_file" onchange="check(event, openapi_key, 2)" />
            </div>
            <div class="sub_information">
                <ol>
                    <li>Ⅱ의 엑셀 서식(변경 금지)에 맞춰 세로 방향으로 사업자등록번호 입력</li>
                    <li>Ⅲ의 파일 선택 버튼 클릭 > 작성한 엑셀 파일 클릭 > 열기 버튼 클릭</li>
                    <li>다운로드된 엑셀 파일 내용 확인(양이 많은 경우 장시간이 소요될 수 있음)</li>
                    <li>오류 발생 시, 작성한 파일의 오류 수정 후 재시도</li>
                </ol>
            </div>
        </div>
        <div class="main">
            <div class="information">
                Ⅳ.&nbsp;&nbsp;주의사항
            </div>
            <div class="sub_information">
                <ul>
                    <li>오류 발생 시, 입력된 엑셀 파일의 내용을 확인하고 새로고침(F5) 후 재시도</li>
                    <li>1회 5천 개, 1일 1억 개(변동 가능) 조회 가능</li>
                </ul>
            </div>
        </div>
    </div>
</body>

<script>
let result = [];
let corps_array = [];
let limit = 100;
let limit2 = 5000;

//사전 점검
function check(event, key, mode) {
    //인증키 입력 여부 확인
    if(key.value === "" || key.value === null) {
        alert("공공데이터포털 오픈API 인증키 값을 넣어주세요.");
    } else if(mode === 1) {
        run_validate(event, key);
    } else if(mode === 2) {
        run_status(event, key);
    }
}

/**********************************************************************************/
/**  진위확인  *********************************************************************/
/**********************************************************************************/
/*
//진위확인
function run_validate(event, key) {
    //파일 읽기
    let input = event.target;
    let reader = new FileReader();
    corps_array = {};
    corps_array.businesses = [];
    let status = true;
    
    reader.onload = function() {
        let fileData = reader.result;
        let wb = XLSX.read(fileData, {type : 'binary'});
        let err = 0;

        wb.SheetNames.forEach(function(sheetName) {
            let rowObj = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);

            if(rowObj.length > limit2) {
                alert("1번에 " + limit2 + "개 이상 확인할 수 없습니다.");
                status = false;
                return;
            }
            
            for(let i = 0; i<rowObj.length; i++) {
                let corp = new Object();
                corp.businesses = {};
                if(rowObj[i]["사업자등록번호(숫자만10자리)"] !== null && rowObj[i]["사업자등록번호(숫자만10자리)"] !== undefined)
                    corp.businesses.b_no = String(rowObj[i]["사업자등록번호(숫자만10자리)"]);
                if(rowObj[i]["개업일자(YYYYMMDD)"] !== null && rowObj[i]["개업일자(YYYYMMDD)"] !== undefined)
                    corp.businesses.start_dt = String(rowObj[i]["개업일자(YYYYMMDD)"]);
                if(rowObj[i].대표자성명1 !== null && rowObj[i].대표자성명1 !== undefined)
                    corp.businesses.p_nm = String(rowObj[i].대표자성명1);
                if(rowObj[i].대표자성명2 !== null && rowObj[i].대표자성명2 !== undefined)
                    corp.businesses.p_nm2 = String(rowObj[i].대표자성명2);
                if(rowObj[i].상호 !== null && rowObj[i].상호 !== undefined)
                    corp.businesses.b_nm = String(rowObj[i].상호);
                if(rowObj[i].법인등록번호 !== null && rowObj[i].법인등록번호 !== undefined)
                    corp.businesses.corp_no = String(rowObj[i].법인등록번호);
                if(rowObj[i].주업태명 !== null && rowObj[i].주업태명 !== undefined)
                    corp.businesses.b_sector = String(rowObj[i].주업태명);
                if(rowObj[i].주종목명 !== null && rowObj[i].주종목명 !== undefined)
                    corp.businesses.b_type = String(rowObj[i].주종목명);
                corps_array.businesses.push(corp.businesses);
            }
        });

        if(status === false)
            return;
            
        result = [];
        call_validate([], 0, key);
    };

    reader.readAsBinaryString(input.files[0]);
}

//진위확인 API 호출
function call_validate(corps, start_num, key) {
    let end_num = start_num;

    if(corps_array.businesses[start_num] !== null) {
        if(corps_array.businesses.length - 1 >= start_num + limit - 1) {
            end_num = start_num + limit - 1;
        } else {
            end_num = corps_array.businesses.length - 1;
        }
    }

    let data = {};
    data.businesses = [];
    for(let i=start_num; i<=end_num; i++) {
        data.businesses.push(corps_array.businesses[i]);
    }

    let xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function () {
        if(xhr.readyState === xhr.DONE) {
            if(xhr.status === 200 || xhr.status === 201) {
                let jqXHR = JSON.parse(xhr.responseText);
                console.log(jqXHR);

                for(let i=0; i<jqXHR.data.length; i++) {
                    corps[start_num + i] = {};
                    corps[start_num + i].b_no = jqXHR.data[i].b_no;
                    corps[start_num + i].valid = jqXHR.data[i].valid;
                    corps[start_num + i].valid_msg = jqXHR.data[i].valid_msg;

                    corps[start_num + i].request_param = {};
                    corps[start_num + i].request_param.start_dt = jqXHR.data[i].request_param.start_dt;
                    corps[start_num + i].request_param.p_nm = jqXHR.data[i].request_param.p_nm;
                    corps[start_num + i].request_param.p_nm2 = jqXHR.data[i].request_param.p_nm2;
                    corps[start_num + i].request_param.b_nm = jqXHR.data[i].request_param.b_nm;
                    corps[start_num + i].request_param.corp_no = jqXHR.data[i].request_param.corp_no;
                    corps[start_num + i].request_param.b_sector = jqXHR.data[i].request_param.b_sector;
                    corps[start_num + i].request_param.b_type = jqXHR.data[i].request_param.b_type;

                    if(jqXHR.data[i].status !== null && jqXHR.data[i].status !== undefined) {
                        corps[start_num + i].status = {};
                        corps[start_num + i].status.b_stt = jqXHR.data[i].status.b_stt;
                        corps[start_num + i].status.b_stt_cd = jqXHR.data[i].status.b_stt_cd;
                        corps[start_num + i].status.tax_type = jqXHR.data[i].status.tax_type;
                        corps[start_num + i].status.tax_type_cd = jqXHR.data[i].status.tax_type_cd;
                        corps[start_num + i].status.end_dt = jqXHR.data[i].status.end_dt;
                        corps[start_num + i].status.utcc_yn = jqXHR.data[i].status.utcc_yn;
                        corps[start_num + i].status.tax_type_change_dt = jqXHR.data[i].status.tax_type_change_dt;
                        corps[start_num + i].status.invoice_apply_dt = jqXHR.data[i].status.invoice_apply_dt;
                    }
                }
                
                if(end_num === corps_array.businesses.length - 1) {
                    console.log(corps);
                    save_validate(corps);
                } else {
                    call_validate(corps, end_num + 1, key)
                }
            } else {
                alert("API 호출 실패");
                console.error(xhr.responseText);
            }
        }
    }
    xhr.open("POST", "https://api.odcloud.kr/api/nts-businessman/v1/validate?serviceKey=" + key.value);
    xhr.setRequestHeader("accept", " application/json");
    xhr.setRequestHeader("Content-Type", " application/json");
    xhr.send(JSON.stringify(data));
}

//진위확인 엑셀 저장
function save_validate(json) {
    let rawList = [];
    let raw = null;

    for(let i=0; i<json.length; i++) {
        raw = {};
        raw.사업자등록번호 = json[i].b_no;
        raw.진위확인결과코드 = json[i].valid;
        raw.진위확인결과메세지 = json[i].valid_msg;

        raw.개업일자 = json[i].request_param.start_dt;
        raw.대표자성명1 = json[i].request_param.p_nm;
        raw.대표자성명2 = json[i].request_param.p_nm2;
        raw.상호 = json[i].request_param.b_nm;
        raw.법인등록번호 = json[i].request_param.corp_no;
        raw.주업태명 = json[i].request_param.b_sector;
        raw.주종목명 = json[i].request_param.b_type;

        if(json[i].status !== null && json[i].status !== undefined) {
            raw.납세자상태 = json[i].status.b_stt;
            raw.납세자상태코드 = json[i].status.b_stt_cd;
            raw.과세유형메세지 = json[i].status.tax_type;
            raw.과세유형메세지코드 = json[i].status.tax_type_cd;
            raw.폐업일 = json[i].status.end_dt;
            raw.단위과세전환폐업여부 = json[i].status.utcc_yn;
            raw.최근과세유형전환일자 = json[i].status.tax_type_change_dt;
            raw.세금계산서적용일자 = json[i].status.invoice_apply_dt;
        }
        
        rawList.push(raw);
    }

    let wb = XLSX.utils.book_new();
    let newWorksheet = XLSX.utils.json_to_sheet(rawList);
    XLSX.utils.book_append_sheet(wb, newWorksheet, "sheet0");
    let wbout = XLSX.write(wb, {bookType:'xlsx',  type: 'binary'});
    saveAs(new Blob([s2ab(wbout)],{type:"application/octet-stream"}), "download.xlsx");
}
*/
/**********************************************************************************/
/**  상태조회  *********************************************************************/
/**********************************************************************************/
//상태조회
function run_status(event, key) {
    //파일 읽기
    let input = event.target;
    let reader = new FileReader();
    corps_array = {};
    corps_array.b_no = [];
    let status = true;
    
    reader.onload = function() {
        let fileData = reader.result;
        let wb = XLSX.read(fileData, {type : 'binary'});
        let err = 0;

        wb.SheetNames.forEach(function(sheetName) {
            let rowObj = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);

            if(rowObj.length > limit2) {
                alert("1번에 " + limit2 + "개 이상 확인할 수 없습니다.");
                status = false;
                return;
            }
            
            for(let i = 0; i<rowObj.length; i++) {
                let corp = new Object();
                corp.b_no = String(rowObj[i]["사업자등록번호(숫자만10자리)"]).trim();
                corps_array.b_no.push(corp.b_no);
            }
        });

        if(status === false)
            return;

        console.log(corps_array);
        result = [];
        call_status([], 0, key);
    };

    reader.readAsBinaryString(input.files[0]);
}

//상태조회 API 호출
function call_status(corps, start_num, key) {
    let end_num = start_num;
    
    if(corps_array.b_no[start_num] !== null) {
        if(corps_array.b_no.length - 1 >= start_num + limit - 1) {
            end_num = start_num + limit - 1;
        } else {
            end_num = corps_array.b_no.length - 1;
        }
    }

    let data = {};
    data.b_no = [];
    for(let i=start_num; i<=end_num; i++) {
        data.b_no.push(corps_array.b_no[i]);
    }

    let xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function () {
        if(xhr.readyState === xhr.DONE) {
            if(xhr.status === 200 || xhr.status === 201) {
                let jqXHR = JSON.parse(xhr.responseText);

                for(let i=0; i<jqXHR.data.length; i++) {
                    corps[start_num + i] = {};
                    corps[start_num + i].b_no = jqXHR.data[i].b_no;
                    corps[start_num + i].b_stt = jqXHR.data[i].b_stt;
                    corps[start_num + i].b_stt_cd = jqXHR.data[i].b_stt_cd;
                    corps[start_num + i].tax_type = jqXHR.data[i].tax_type;
                    corps[start_num + i].tax_type_cd = jqXHR.data[i].tax_type_cd;
                    corps[start_num + i].end_dt = jqXHR.data[i].end_dt;
                    corps[start_num + i].utcc_yn = jqXHR.data[i].utcc_yn;
                    corps[start_num + i].tax_type_change_dt = jqXHR.data[i].tax_type_change_dt;
                    corps[start_num + i].invoice_apply_dt = jqXHR.data[i].invoice_apply_dt;
                }
                
                if(end_num === corps_array.b_no.length - 1) {
                    save_status(corps);
                } else {
                    call_status(corps, end_num + 1, key)
                }
            } else {
                alert("API 호출 실패");
                console.error(xhr.responseText);
            }
        }
    }
    xhr.open("POST", "https://api.odcloud.kr/api/nts-businessman/v1/status?serviceKey=" + key.value);
    xhr.setRequestHeader("accept", " application/json");
    xhr.setRequestHeader("Content-Type", " application/json");
    xhr.send(JSON.stringify(data));
}

//상태조회 엑셀 저장
function save_status(json) {
    let rawList = [];
    let raw = null;

    for(let i=0; i<json.length; i++) {
        raw = {};
        raw.사업자등록번호 = json[i].b_no;
        raw.납세자상태 = json[i].b_stt;
        raw.납세자상태코드 = json[i].b_stt_cd;
        raw.과세유형메세지 = json[i].tax_type;
        raw.과세유형메세지코드 = json[i].tax_type_cd;
        raw.폐업일 = json[i].end_dt;
        raw.단위과세전환폐업여부 = json[i].utcc_yn;
        raw.최근과세유형전환일자 = json[i].tax_type_change_dt;
        raw.세금계산서적용일자 = json[i].invoice_apply_dt;
        
        rawList.push(raw);
    }
    console.log(rawList);

    let wb = XLSX.utils.book_new();
    let newWorksheet = XLSX.utils.json_to_sheet(rawList);
    XLSX.utils.book_append_sheet(wb, newWorksheet, "sheet0");
    let wbout = XLSX.write(wb, {bookType:'xlsx',  type: 'binary'});
    saveAs(new Blob([s2ab(wbout)],{type:"application/octet-stream"}), "result.xlsx");
}

/**********************************************************************************/
/**  기타  ************************************************************************/
/**********************************************************************************/
//엑셀 저장
function s2ab(data) { 
    let buf = new ArrayBuffer(data.length);
    let view = new Uint8Array(buf);

    for(let i = 0; i < data.length; i++)
        view[i] = data.charCodeAt(i) & 0xFF;

    return buf;
}
</script>
<style>
    body, html {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0 auto;
    }
    .container {
        padding: 0;
        margin: 0 auto;
        height: 100%;
        width: 100%;
        position: relative;
    }
    .header {
        width: 100%;
        height: 75px;
        font-size: 1.2rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgb(000, 054, 104);
        border: 1px solid rgba(33,37,41,.1);
        border-radius: .25rem;
        text-align: center;
        color: #FFFFFF;
        max-height: 100%;
    }
    .main {
        width: 100%;
        font-size: 1rem;
        padding: 0.8rem;
        border-bottom: 1px solid rgba(33,37,41,.1);
        border-left: 1px solid rgba(33,37,41,.1);
        border-right: 1px solid rgba(33,37,41,.1);
    }
    #openapi_key {
        width: 85%;
        display: inline-block;
    }
    .information {
        font-size: 1rem;
        font-weight: bold;
    }
    .sub_information {
        padding-top: 10px;
        font-size: 0.9rem;
    }
</style>
</html>